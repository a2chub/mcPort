# MC.Port 仕様設計書

## 概要
MC-Portは、同一マシン内で起動する複数のMCPサーバーに対し、空きポートの自動割り当てとサービス情報の集中管理を行う軽量ミドルウェアです。各MCPサーバーは起動時にMC-Portへポート割り当てを要求し、取得後に自身のサービス内容を登録します。DHCPのポート版に近い挙動を想定します。

## 目的
- ポート衝突を防ぎ、手動管理の負担を減らす
- サービス登録によってマシン内で提供される機能を一元的に把握する
- クロスプラットフォームで動作し、DXT形式での簡易配布を可能にする

## 典型的な利用シーン
1. 開発用PC上で複数のMCPサーバーを並行起動したい場合
2. CI環境など自動化されたジョブが動的にポートを確保してサーバーを立ち上げる場合

## 要求仕様
1. **ポートの自動割り当て**
   - 設定ファイルで指定されたポート範囲から未使用ポートを抽出し割り当てる
   - 割り当て状態を永続化し、再起動後も復元できる
2. **サービス登録と一覧取得**
   - MCPサーバーは割り当てられたポート番号、サービス名、説明をMC-Portへ登録する
   - 登録された内容はAPIまたはCLIから一覧表示できる
3. **動作環境**
   - Linux/macOSを主対象とし、可能であればWindowsもサポートする

## システム構成
- **MC-Portデーモン**: ポート管理と登録情報保持を担う常駐プロセス。HTTPもしくはgRPCのAPIを提供
- **クライアントライブラリ**: MCPサーバーがMC-Portと通信するための軽量ライブラリ。言語実装はGoを想定
- **データストア**: JSONファイルまたはSQLiteを利用し、割り当て情報とサービス登録情報を保持
- **設定ファイル**: ポート範囲やデータ保存先を記述するYAML形式のファイル

### ポート割り当てアルゴリズム
1. 設定ファイルで定義された`start`から`end`までのポート番号を昇順に走査
2. OSの`bind`システムコールを用いて実際に利用可能かを検証
3. 使用可能なポートが見つかり次第、割り当てリストへ登録しクライアントへ返却
4. 割り当て済みポートは永続ストアへ書き込み、デーモン再起動時に復元する
5. `release`エンドポイントを通じてポート解放指示があればリストから削除

### データ保存形式
JSONもしくはSQLiteのレコードとして以下の情報を保持する。

| フィールド | 説明 |
| --- | --- |
| `port` | 割り当てたポート番号 |
| `service_name` | MCPサーバーが登録したサービス名 |
| `description` | サービスの簡易説明 |
| `lease_time` | (任意) リース有効期限 |


## 処理フロー
1. MCPサーバー起動時にクライアントライブラリから`/allocate`エンドポイントへリクエスト
2. MC-Portは空きポートを選択して応答し、内部ストアへ確保情報を保存
3. MCPサーバーは割り当てられたポートで起動後、`/register`エンドポイントでサービス内容を登録
4. クライアントまたは管理者は`/services`エンドポイントから登録済みサービス一覧を参照
5. MCPサーバー終了時は`/release`エンドポイントを呼び出し、MC-Portはポートを解放

## API仕様（案）
| メソッド | パス | 説明 |
| --- | --- | --- |
| `POST` | `/allocate` | 空きポートを1つ割り当てる |
| `POST` | `/register` | サービス名・説明・ポート番号を登録 |
| `POST` | `/release` | 使用終了したポートを解放 |
| `GET` | `/services` | 登録されているサービス一覧を取得 |

### APIリクエスト例
```http
POST /allocate HTTP/1.1
Content-Type: application/json

{}
```
レスポンス例:
```json
{
  "port": 20010
}
```


## 設定ファイル例
```yaml
port_range:
  start: 20000
  end: 21000
store_path: /var/lib/mcport/state.json
```

## セキュリティと運用上の考慮
- 通信は同一マシン内に限定し、必要に応じてUNIXドメインソケットを利用する
- 認証が必要な場合はローカルユーザーによるシンプルなトークン認証方式を検討
- ロギングと監視の仕組みを提供し、異常検知やトラブルシュートを容易にする

### 運用ポリシー
- ストアファイルのバックアップは定期的に取得する
- デーモンのログは日次でローテーションし、長期保存は行わない

### 非目標
- 本設計ではクラスタリングやネットワーク越しの割り当てを扱わない
- 高可用性や冗長化は今後の検討事項とする

## 将来的な拡張案
- ポート割り当てのリース期間を設定し、一定時間アクセスが無いポートを自動解放する
- サービス依存関係の記録やヘルスチェックAPIの提供
- WebベースのGUIツールを実装し、ポート状態や登録サービスを視覚的に管理

